{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/helpers/createInitialError.js","webpack:///./src/helpers/isDevContext.js","webpack:///./src/helpers/jsonapiMedia.js","webpack:///./src/index.js","webpack:///./src/middleware/bodyParser.js","webpack:///./src/middleware/ensureErrorHandling.js","webpack:///./src/middleware/errors.js","webpack:///./src/middleware/exposeContextProps.js","webpack:///./src/middleware/validate.js","webpack:///external \"@alexeimyshkouski/json-api\"","webpack:///external \"babel-runtime/core-js/object/assign\"","webpack:///external \"babel-runtime/core-js/object/define-properties\"","webpack:///external \"babel-runtime/helpers/asyncToGenerator\"","webpack:///external \"babel-runtime/helpers/toConsumableArray\"","webpack:///external \"babel-runtime/regenerator\"","webpack:///external \"http-errors\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-router\"","webpack:///external \"lodash.defaultsdeep\""],"names":["error","message","stack","ctx","app","env","JSON_API_MEDIA_TYPES","JSON_API_MEDIA_TYPES_DEV","types","stringify","arrayOfTypes","filter","type","join","JsonApiRouter","options","validate","patch","request","response","router","use","validatePatch","Router","getSchemas","jsonapiMedia","strict","enableTypes","detectJSON","mediaTypes","isJSON","is","assert","parser","next","rawBody","state","hasBody","length","throw","statusCode","details","headers","accept","isDev","errors","status","push","_error","detail","meta","initialError","undefined","body","mapErrorsToJsonApiErrors","id","expose","jsonapiError","title","jsonapiMeta","contentTypes","Array","isArray","map","set","properties","mapKeys","value","keys","reduce","_value","key","jsonapi","data","add","path","ops","hasErrors","has","get","unshift","op","reasons"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// object to store loaded and loading wasm modules\n \tvar installedWasmModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// object with all compiled WebAssembly.Modules\n \t__webpack_require__.w = {};\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","export default error => Object.assign({}, error, {\r\n  message: error.message,\r\n  stack: error.stack\r\n})\r\n","export default ctx => ctx.app.env == 'development'\r\n","import isDevContext from '~/helpers/isDevContext'\r\n\r\nexport const JSON_API_MEDIA_TYPES = ['application/vnd.api+json']\r\nexport const JSON_API_MEDIA_TYPES_DEV = ['application/json']\r\n\r\nexport const types = ctx => isDevContext(ctx) ? [...JSON_API_MEDIA_TYPES, ...JSON_API_MEDIA_TYPES_DEV] : [...JSON_API_MEDIA_TYPES]\r\nexport const stringify = arrayOfTypes => arrayOfTypes.filter(type => !!type).join(',')\r\n","import Router from 'koa-router'\r\nimport defaults from 'lodash.defaultsdeep'\r\n\r\nimport JsonApi from '@alexeimyshkouski/json-api'\r\n\r\nimport exposeContextProps from './middleware/exposeContextProps'\r\nimport ensureErrorHandling from './middleware/ensureErrorHandling'\r\nimport errors from './middleware/errors'\r\nimport validate from './middleware/validate'\r\nimport bodyParser from './middleware/bodyParser'\r\n\r\nfunction JsonApiRouter(options) {\r\n  options = defaults({}, options, {\r\n    validate: {\r\n      patch: false,\r\n      request: true,\r\n      response: false\r\n    }\r\n  })\r\n  \r\n  const router = new Router(options)\r\n\r\n  return router\r\n    .use(ensureErrorHandling())\r\n      .use(exposeContextProps({ validatePatch: options.validate.patch }))\r\n      .use(errors())\r\n        .use(bodyParser())\r\n        .use(validate({\r\n          request: options.validate.request,\r\n          response: options.validate.response\r\n        }))\r\n}\r\n\r\nexport { JsonApiRouter as Router }\r\n\r\nexport const getSchemas = options => JsonApi.getSchemas(options)\r\n","import bodyParser from 'koa-bodyparser'\r\nimport isDevContext from '../helpers/isDevContext'\r\nimport * as jsonapiMedia from '../helpers/jsonapiMedia'\r\n\r\nconst options = {\r\n  strict: true,\r\n  enableTypes: ['json'],\r\n  detectJSON: ctx => {\r\n    const mediaTypes = jsonapiMedia.types(ctx)\r\n    const isJSON = !!ctx.request.is(...mediaTypes)\r\n    ctx.assert(isJSON, 415)\r\n    return isJSON\r\n  }\r\n}\r\n\r\nexport default options => {\r\n  const parser = bodyParser(options)\r\n\r\n  return async (ctx, next) => {\r\n    try {\r\n      await parser(ctx, async () => {\r\n        const rawBody = ctx.request.rawBody\r\n        ctx.state.hasBody = !!(rawBody && rawBody.length)\r\n      })\r\n    } catch (error) {\r\n      ctx.throw(error.statusCode || 415, {\r\n        details: error.message,\r\n        headers: {\r\n          accept: jsonapiMedia.stringify(jsonapiMedia.types(ctx))\r\n        }\r\n      })\r\n    }\r\n\r\n    await next()\r\n  }\r\n}\r\n","import HttpError from 'http-errors'\r\nimport isDevContext from '../helpers/isDevContext'\r\nimport createInitialError from '../helpers/createInitialError'\r\n\r\nexport default () => async (ctx, next) => {\r\n  try {\r\n    await next()\r\n    // throw new Error('test')\r\n  } catch (error) {\r\n    const isDev = isDevContext(ctx)\r\n    const errors = []\r\n\r\n    if (error.status) {\r\n      errors.push(Object.assign({\r\n        status: error.status\r\n      }, error))\r\n    } else {\r\n      const _error = new HttpError(500, {\r\n        detail: `JSON API implementation error`,\r\n        meta: isDev ? {\r\n          initialError: createInitialError(error)\r\n        } : undefined\r\n      })\r\n\r\n      errors.push(Object.assign({\r\n        status: _error.status\r\n      }, _error))\r\n    }\r\n\r\n    ctx.status = errors[0].status\r\n    ctx.body = {\r\n      errors\r\n    }\r\n  }\r\n}\r\n","import HttpError from 'http-errors'\r\nimport isDevContext from '../helpers/isDevContext'\r\nimport * as jsonapiMedia from '../helpers/jsonapiMedia'\r\nimport createInitialError from '../helpers/createInitialError'\r\n\r\nconst mapErrorsToJsonApiErrors = isDev => error => {\r\n  const {\r\n    id,\r\n    status,\r\n    expose,\r\n    message,\r\n    detail,\r\n    stack,\r\n    headers,\r\n    meta\r\n  } = error\r\n\r\n  const jsonapiError = {\r\n    id: error.id,\r\n    status: error.status\r\n  }\r\n\r\n  if(isDev || expose) {\r\n    Object.assign(jsonapiError, {\r\n      title: message,\r\n      detail\r\n    })\r\n  }\r\n\r\n  if(isDev || headers) {\r\n    const jsonapiMeta = Object.assign({}, meta, {\r\n      headers,\r\n      stack: isDev ? stack : undefined\r\n    })\r\n\r\n    Object.assign(jsonapiError, {\r\n      meta: jsonapiMeta\r\n    })\r\n  }\r\n\r\n  return jsonapiError\r\n}\r\n\r\nexport default () => async (ctx, next) => {\r\n  const isDev = isDevContext(ctx)\r\n  const contentTypes = jsonapiMedia.types(ctx)\r\n\r\n  try {\r\n    await next()\r\n  } catch (errorOrErrors) {\r\n    let errors = (Array.isArray(errorOrErrors) ? errorOrErrors : [errorOrErrors])\r\n\r\n    const initialError = errors[0]\r\n\r\n    if(!initialError.status) {\r\n      ctx.throw(500, {\r\n        detail: `Initial error has no status code. Assuming it is an implementation error.`,\r\n        meta: {\r\n          initialError: createInitialError(initialError)\r\n        }\r\n      })\r\n    }\r\n\r\n    errors = errors.map(mapErrorsToJsonApiErrors(isDev))\r\n\r\n    if (errors.length > 1) {\r\n      if (initialError.status >= 500) {\r\n        ctx.status = 500\r\n      } else if (initialError.status >= 400) {\r\n        ctx.status = 400\r\n      }\r\n    } else {\r\n      ctx.status = initialError.status\r\n      if ('meta' in initialError && 'headers' in initialError.meta) {\r\n        ctx.set(initialError.meta.headers)\r\n      }\r\n    }\r\n\r\n    ctx.body = {\r\n      errors\r\n    }\r\n  }\r\n}\r\n","import JsonApi from '@alexeimyshkouski/json-api'\nimport * as jsonapiMedia from '../helpers/jsonapiMedia'\n\nconst properties = ['data', 'meta', 'links']\nconst mapKeys = (value, keys) => {\n  if(!value) {\n    return value\n  }\n\n  return keys\n    .reduce((_value, key) => {\n      _value[key] = value[key]\n      return _value\n    }, {})\n}\n\nexport default options => async (ctx, next) => {\n  ctx.body = {}\n  const mediaTypes = jsonapiMedia.types(ctx)\n\n  ctx.jsonapi = new JsonApi(\n    Object.assign({}, options, {\n      body: ctx.body\n    })\n  )\n\n  Object.defineProperties(ctx, {\n    data: {\n      value(data) {\n        this.jsonapi.add('/data', data)\n      }\n    },\n    error: {\n      value(value) {\n        const path = '/errors'\n\n        const ops = []\n        const hasErrors = this.jsonapi.has(path)\n        let errors\n\n        if(hasErrors) {\n          errors = this.jsonapi.get(path)\n        } else {\n          errors = []\n        }\n\n        if(Array.isArray(value)) {\n          errors = [...errors, ...value]\n        } else {\n          errors = [...errors, value]\n        }\n\n        if(hasErrors) {\n          ops.unshift({ op: 'replace', path, value: errors })\n        } else {\n          ops.unshift({ op: 'add', path, value: errors })\n        }\n\n        this.jsonapi.patch(ops)\n      }\n    }\n  })\n\n  // Object.defineProperties(ctx, properties.reduce((descriptor, prop) => {\n  //   descriptor[prop] = {\n  //     async value(...args) {\n  //       let path = '', value, options = {}\n  //\n  //       if(typeof args[0] == 'string') {\n  //         path = args[0]\n  //         value = args[1]\n  //\n  //         if(args.length > 2) {\n  //           options = args[2]\n  //         }\n  //       } else {\n  //         value = args[0]\n  //         if(args.length > 1) {\n  //           options = args[1]\n  //         }\n  //       }\n  //\n  //       let _value\n  //\n  //       if('keys' in options) {\n  //         if(Array.isArray(value)) {\n  //           _value = value.map(item => mapKeys(item, options.keys))\n  //         } else {\n  //           _value = mapKeys(value, options.keys)\n  //         }\n  //       } else {\n  //         _value = value\n  //       }\n  //\n  //       return await ctx.jsonapi.add(`/${ prop }${ path }`, _value)\n  //     }\n  //   }\n  //\n  //   return descriptor\n  // }, {}))\n\n  await next()\n\n  ctx.set('content-type', `${ mediaTypes[0] };charset=utf-8`)\n}\n","import JsonApi from '@alexeimyshkouski/json-api'\r\nimport defaults from 'lodash.defaultsdeep'\r\n\r\nexport default options => {\r\n  options = defaults({}, options, {\r\n    request: true,\r\n    response: false\r\n  })\r\n\r\n  return async (ctx, next) => {\r\n    if (options.request && ctx.state.hasBody) {\r\n      try {\r\n        await JsonApi.validate(ctx.request.body)\r\n      } catch (error) {\r\n        ctx.throw(422, {\r\n          detail: `ValidationError: request body is not valid`,\r\n          meta: error.reasons\r\n        })\r\n      }\r\n    }\r\n\r\n    await next()\r\n\r\n    if (options.response) {\r\n      try {\r\n        await JsonApi.validate(ctx.body)\r\n      } catch (error) {\r\n        Object.assign({\r\n          detail: `ValidationError: response body is not valid`,\r\n          meta: error.reasons\r\n        })\r\n\r\n        throw error\r\n      }\r\n    }\r\n  }\r\n}\r\n","module.exports = require(\"@alexeimyshkouski/json-api\");","module.exports = require(\"babel-runtime/core-js/object/assign\");","module.exports = require(\"babel-runtime/core-js/object/define-properties\");","module.exports = require(\"babel-runtime/helpers/asyncToGenerator\");","module.exports = require(\"babel-runtime/helpers/toConsumableArray\");","module.exports = require(\"babel-runtime/regenerator\");","module.exports = require(\"http-errors\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-router\");","module.exports = require(\"lodash.defaultsdeep\");"],"sourceRoot":""}